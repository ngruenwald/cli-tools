name = "qemu"
description = "A generic and open source machine emulator and virtualizer."
homepage = "https://www.qemu.org"
alternatives = []
version = "10.1.0"
updated = "2025-08-26"
package-url = ""
query-url = "https://github.com/qemu/qemu/archive/refs/tags/v{{version}}.tar.gz"

[extract]
strip = 1
prefix = "{{vars.prefix-path}}"

#
# build configuration
#

[build]
query-url = "https://github.com/qemu/qemu/archive/refs/tags/v{{version}}.tar.gz"
package-url = "https://download.qemu.org/qemu-{{version}}.tar.xz"
#package-url = "https://10.172.113.102/src/qemu/qemu-{{version}}.tar.xz"
verify-ssl = false

[[build.script]]
name = "build_qemu.sh"
content = [
    "set -e",

    "apk add \\",
    "  bash \\",
    "  bison \\",
    "  flex \\",
    "  gcc \\",
    "  git \\",
    "  glib-dev glib-static \\",
    "  libc-dev \\",
    "  linux-headers \\",
    "  make \\",
    "  patch \\",
    "  pcre2-dev pcre2-static \\",
    "  perl \\",
    "  pkgconf \\",
    "  python3 \\",
    "  samurai \\",
    "  valgrind-dev \\",
    "  xz \\",
    "  zlib-dev zlib-static",

    "mkdir qemu",
    "tar xJf qemu-{{version}}.tar.xz --strip-components=1 -C qemu",
    "cd qemu",

    "export LDFLAGS=\"-static\"",
    "export PKG_CONFIG=\"pkg-config --static\"",

    "./configure \\",
    "  --prefix=$(pwd)/dist \\",
    "  --target-list=arm-linux-user,aarch64-linux-user \\",
    "  --enable-strip \\",
    "  --enable-user \\",
    "  --enable-linux-user \\",
    "  --enable-membarrier \\",
    "  --enable-valgrind \\",
    "  --disable-debug-info \\",
    "  --disable-system \\",
    "  --disable-alsa \\",
    "  --disable-coreaudio \\",
    "  --disable-guest-agent \\",
    "  --disable-jack \\",
    "  --disable-modules \\",
    "  --disable-oss \\",
    "  --disable-plugins \\",
    "  --disable-sdl \\",
    "  --disable-sdl-image \\",
    "  --disable-spice \\",
    "  --disable-spice-protocol \\",
    "  --disable-virglrenderer \\",
    "  --disable-vnc \\",
    "  --disable-vnc-jpeg \\",
    "  --disable-vnc-sasl \\",
    "  --disable-rdma \\",
    "  --disable-vhost-vdpa \\",
    "  --disable-opengl \\",
    "  --static",

    "make -j {{vars.num-parallel}} LDFLAGS=\"-static -all-static\"",
    "make install",

    "tar cJf ../qemu-{{version}}-linux.x86_64.tar.xz -C $(pwd)/dist .",

    "cd ..",
    "rm -rf qemu"  #  workaround, our host process will fail to remove the temp folder
]

[[build.step]]
command = ["podman", "run", "--rm", "-it", "-v", "$PWD:$PWD", "-w", "$PWD", "alpine:3.22", "sh", "build_qemu.sh"]

[[build.publish]]
repository-name = "packages"
repository-path = "qemu"
files = ["qemu-{{version}}-linux.x86_64.tar.xz"]
