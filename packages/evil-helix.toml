name = "evil-helix"
description = "Bringing the Helix editor to the evil side"
homepage = "https://github.com/usagi-flow/evil-helix"
alternatives = [ "vim", "neovim", "helix" ]
version = "20250915"
updated = "2025-09-16"
package-url = "https://github.com/usagi-flow/evil-helix/releases/download/release-{{version}}/helix-amd64-linux.tar.gz"
version-pattern = "^release-\\d+$"

[extract]
strip = 1

[[extract.files]]
source = "hx"
target = "{{vars.bin-path}}/hx"
mode = "0755"

[[extract.files]]
source = "runtime"
target = "{{vars.bin-path}}/runtime"
is_folder = true

#
# build configuration
#

[build]
package-url = "https://github.com/usagi-flow/evil-helix/archive/refs/tags/release-{{version}}.tar.gz"

[[build.script]]
name = "build_helix.sh"
content = [
    "set -e",

    "apk add \\",
    "  cargo \\",
    "  clang \\",
    "  git \\",
    "  glib-dev glib-static \\",
    "  libc-dev \\",
    "  lld \\",
    "  rust",

    "export CC=clang",
    "export CXX=clang++",
    "export CFLAGS=\"-static\"",
    "export CCFLAGS=\"-static\"",
    "export CXXFLAGS=\"-static\",
    "export LDFLAGS=\"-static\"",
    "export PKG_CONFIG=\"pkg-config --static\"",
    "export RUSTFLAGS=\"-C target-feature=+crt-static\"",

    "mkdir helix-build",
    "cd helix-build",
    "tar xzf ../release-{{version}}.tar.gz --strip-components=1",

    "cargo install --target x86_64-alpine-linux-musl --path helix-term --locked",

    "mkdir -p _dist_/evil-helix-{{version}}-x86_64-linux/contrib",
    "mkdir -p _dist_/evil-helix-{{version}}-x86_64-linux/runtime/grammars",
    "cp /root/.cargo/bin/hx   _dist_/evil-helix-{{version}}-x86_64-linux/",
    "cp runtime/grammars/*.so _dist_/evil-helix-{{version}}-x86_64-linux/runtime/grammars/",
    "cp runtime/tutor         _dist_/evil-helix-{{version}}-x86_64-linux/runtime/",
    "cp -r runtime/queries    _dist_/evil-helix-{{version}}-x86_64-linux/runtime/",
    "cp -r runtime/themes     _dist_/evil-helix-{{version}}-x86_64-linux/runtime/",
    "cp -r contrib/completion _dist_/evil-helix-{{version}}-x86_64-linux/contrib/",

    "mkdir -p _dist_/evil-helix-{{version}}-x86_64-linux/lib",
    "cp /lib/ld-musl-x86_64.so.1 _dist_/evil-helix-{{version}}-x86_64-linux/lib",

    "strip --strip-all _dist_/evil-helix-{{version}}-x86_64-linux/hx",

    "echo \"creating package...\"",
    "cd _dist_",
    "tar cJf ../../helix-evil-{{version}}-x86_64-linux.tar.xz evil-helix-{{version}}-x86_64-linux",

    "cd ../..",
    "rm -rf helix-build"
]

[[build.step]]
command = ["podman", "run", "--rm", "-it", "-v", "$PWD:$PWD", "-w", "$PWD", "alpine:3.22", "sh", "build_helix.sh"]

[[build.publish]]
repository-name = "packages"
repository-path = "helix"
files = ["helix-evil-{{version}}-x86_64-linux.tar.xz"]
